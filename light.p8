pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- globals

frame=0
shadow_col=0

bunny_base={
	spr=17,
	w=6,
	h=8,
}

bat_base={
	spr=18,
	w=8,
	h=8,
}

CHECKERBOARD=0b1010010110100101.1

t1={x=40,y=90,r=20}
t2={x=80,y=40,r=20}

actors={}
torches={}

-->8
-- drawing routines

function add_actor(base,x,y)
	add(actors,{ base=base, x=x, y=y })
end

function add_torch(x,y,r)
	add(torches, { x=x, y=y, r=r })
end

function draw_actors()
	for a in all(actors) do
		spr(a.base.spr,a.x,a.y)
	end
end

function draw_actors_binary()
	for a in all(actors) do
		for t in all(torches) do
			if a.x>t.x+t.r or a.x+a.base.w<=t.x-t.r or a.y>t.y+t.r or a.y+a.base.h<=t.y-t.r then
				-- totally outside range, save calculation
			else
				local check_x,check_y
				if a.x>=t.x then
					check_x=a.x
				elseif a.x+a.base.w<=t.x then
					check_x=a.x+a.base.w
				else
					check_x=t.x
				end
				if a.y>=t.y then
					check_y=a.y
				elseif a.y+a.base.h<=t.y then
					check_y=a.y+a.base.h
				else
					check_y=t.y
				end
				if (t.x-check_x)*(t.x-check_x)+(t.y-check_y)*(t.y-check_y)<=t.r*t.r then
					spr(a.base.spr,a.x,a.y)
					break
				end
			end
		end
	end
end

function draw_plain_stripes(torch, col)
	rectfill(0,0,127,torch.y-torch.r,col)
	rectfill(0,127,127,torch.y+torch.r,col)
	for y=torch.y-torch.r+1,torch.y+torch.r-1 do
		local x=sqrt(torch.r*torch.r-(torch.y-y)*(torch.y-y))
		line(0,y,torch.x-x,y,col)
		line(127,y,torch.x+x,y,col)
	end
end

function draw_map_stripes(torch)
	-- greyscale - taken from PICO docs
	pal({1,1,5,5,5,6,7,13,6,7,7,6,13,6,7,1})
	for y=0,127 do
		if y<=torch.y-torch.r or y>=torch.y+torch.r then
			tline(0,y,127,y,0,y*0.125)
		else
			local x=sqrt(torch.r*torch.r-(torch.y-y)*(torch.y-y))
			tline(0,y,torch.x-x,y,0,y*0.125)
			tline(torch.x+x,y,127,y,(torch.x+x)*0.125,y*0.125)
		end
	end
	pal()
end

function draw_2_checkerboard(torch_a, torch_b, col)
	fillp(CHECKERBOARD)
	draw_plain_stripes(torch_a, col)
	fillp(~CHECKERBOARD&0xffff|0b0.1)
	draw_plain_stripes(torch_b, col)
	fillp()
end

function draw_alt_stripes(torch, startline, col)
	for y=startline,127,2 do
		if y<=torch.y-torch.r or y>=torch.y+torch.r then
			line(0,y,127,y,col)
		else
			local x=sqrt(torch.r*torch.r-(torch.y-y)*(torch.y-y))
			line(0,y,torch.x-x,y,col)
			line(127,y,torch.x+x,y,col)
		end
	end
end

function draw_2_alt_stripes(torch_a, torch_b, col)
	draw_alt_stripes(torch_a, 0, col)
	draw_alt_stripes(torch_b, 1, col)
end

-->8
-- top-level flow

function _init()
	add_actor(bunny_base,16,43)
	add_actor(bunny_base,80,27)
	add_actor(bunny_base,50,115)
	add_actor(bunny_base,60,115)
	add_actor(bat_base,40,24)
	add_actor(bat_base,104,80)
	add_actor(bat_base,64,88)
	add_actor(bat_base,100,108)

	add_torch(40,90,20)
	add_torch(80,40,20)
end

function _update()
	frame+=1
	if (btn(‚¨áÔ∏è)) torches[1].y+=1
	if (btn(‚¨ÜÔ∏è)) torches[1].y-=1
	if (btn(‚¨ÖÔ∏è)) torches[1].x-=1
	if (btn(‚û°Ô∏è)) torches[1].x+=1
	if btn(‚ùé) then
		torches[1].r=max(torches[1].r-1,0)
	end
	if (btn(üÖæÔ∏è)) torches[1].r+=1
end

function _draw()
	map()
	-- draw_actors()

	-- simplest fill for a single circle:
	-- draw_plain_stripes(torches[1], shadow_col)

	-- fill one circle with greyscale map:
	-- draw_map_stripes(torches[1])

	-- fill two circles stripily:
	-- draw_2_alt_stripes(torches[1], torches[2], shadow_col)

	-- fill two circles with alternating stripes:
	-- if frame%20<10 then
	-- 	draw_2_alt_stripes(torches[1], torches[2], shadow_col)
	-- else
	-- 	draw_2_alt_stripes(torches[2], torches[1], shadow_col)
	-- end

	-- fill two circles with checkerboards
	draw_2_checkerboard(torches[1], torches[2], shadow_col)

	-- draw entire actor if it has any overlap with a light source
	draw_actors_binary()

	print('\#0cpu '..flr(stat(1)*100)..'%',0,0,7)
end

__gfx__
0000000033333333333333333333333333333333bbbbbbbbbbbbbbb3bbbbbbbbbbbbbbbb33333333bbbbbbbb0000000000000000000000000000000000000000
0000000033a333333b333b333338833333333333bbbbbbbbbbbbbbb3bbbbbbbbbbbbbbbb33333333bbbbbbbb0000000000000000000000000000000000000000
007007003aaa3333333b33333388883333333333bbbbbbbbbbbbb333bbbbbbbb3bbbbbbb33333333bbbbbbbb0000000000000000000000000000000000000000
0007700033a333333b33333333888833bb333bbbbbbbbbbbbbb33333bbbbbbbb3333bbbb33333333bbbbbbbb0000000000000000000000000000000000000000
00077000333333333333b33333888833bbbbbbbb33bbb333bb333333bbbbbbbb33333333333333bbbbbbbbbb0000000000000000000000000000000000000000
007007003333333333b3333b33388333bbbbbbbb333333333333333333bbbbbb333333333333bbbbbbbbbbbb0000000000000000000000000000000000000000
00000000333333333333333333333333bbbbbbbb33333333333333333333bbbb33333333333bbbbbbbbbbbbb0000000000000000000000000000000000000000
00000000333333333333b33333333333bbbbbbbb3333333333333333333333bb333333333bbbbbbbbbbbbbbb0000000000000000000000000000000000000000
000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000ee0eee01000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000eee0001100001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001e10001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000eee0001119191100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000e00000011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000eee0000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000ee0ee000010010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0505050505050505050505050505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202030202020209040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020202090404040a050505050505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040a05050506020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0505050601010202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020101010202020203020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020201010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020302020202020201010200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020302020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020203020203020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
